(function() {
  var postSettings = {
    applicationId: 5884363,
    postText: 'This message is generated by js, has the image been posted ?!',
    getImageUrlMethod: '/get_image_url'
  };

  VK.init({
    apiId: postSettings.applicationId,
    status: true
  });

  VK.Auth.login(function(login) {
    console.log(login.status);
  });

  httpGet(postSettings.getImageUrlMethod).then(function(res) {
    postOnWall(postSettings.postText, JSON.parse(res));
  }).catch(function(err) {console.warn(err.toString());});

  function postOnWall(message, parsed) {
    VK.api('wall.post', {owner_id: '-' + parsed.groupId, message: message, attachments: parsed.imageId}, function(response) {
      alert('Post has been created!');
    });
  }

  function httpGet(url) {
    return new Promise(function(resolve, reject) {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.onload = function() {
        if (this.status == 200) {
          resolve(this.response);
        } else {
          var error = new Error(this.statusText);
          error.code = this.status;
          reject(error);
        }
      };
      xhr.onerror = function() {
        reject(new Error("Network Error"));
      };
      xhr.send();
    });
  }
})();